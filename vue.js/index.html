<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Management System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="#">üìö Lesson Management</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: currentView === 'lessons' }" 
                               href="#" @click.prevent="currentView = 'lessons'">
                                Lessons
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: currentView === 'cart' }" 
                               href="#" @click.prevent="currentView = 'cart'">
                                Cart ({{ cartItems.length }})
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" :class="{ active: currentView === 'orders' }" 
                               href="#" @click.prevent="currentView = 'orders'">
                                Orders
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <!-- Lessons View -->
            <div v-if="currentView === 'lessons'">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h2>Available Lessons</h2>
                    </div>
                    <div class="col-md-6">
                        <!-- Search and Sort Controls -->
                        <div class="row">
                            <div class="col-md-7">
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    placeholder="üîç Search lessons by subject or location..." 
                                    v-model="searchQuery">
                            </div>
                            <div class="col-md-5">
                                <select class="form-select" v-model="sortBy">
                                    <option value="subject">üìö Sort by Subject</option>
                                    <option value="location">üìç Sort by Location</option>
                                    <option value="price">üí∞ Sort by Price</option>
                                    <option value="availability">üë• Sort by Spaces</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-2 d-flex justify-content-between align-items-center">
                            <button class="btn btn-sm" 
                                    :class="sortOrder === 'asc' ? 'btn-success' : 'btn-warning'"
                                    @click="sortOrder = sortOrder === 'asc' ? 'desc' : 'asc'">
                                <i class="fas me-2" :class="{
                                    'fa-sort-alpha-up': (sortBy === 'subject' || sortBy === 'location') && sortOrder === 'asc',
                                    'fa-sort-alpha-down': (sortBy === 'subject' || sortBy === 'location') && sortOrder === 'desc',
                                    'fa-sort-numeric-up': (sortBy === 'price' || sortBy === 'availability') && sortOrder === 'asc',
                                    'fa-sort-numeric-down': (sortBy === 'price' || sortBy === 'availability') && sortOrder === 'desc'
                                }"></i>
                                <strong>{{ sortOrder === 'asc' ? 'Ascending' : 'Descending' }}</strong>
                                <span class="badge bg-light text-dark ms-2">
                                    {{ sortOrder === 'asc' ? 'A‚ÜíZ' : 'Z‚ÜíA' }}
                                    <span v-if="sortBy === 'price' || sortBy === 'availability'">
                                        {{ sortOrder === 'asc' ? ' (Low‚ÜíHigh)' : ' (High‚ÜíLow)' }}
                                    </span>
                                </span>
                            </button>
                            <div class="text-end">
                                <small class="text-muted d-block">Currently sorting by:</small>
                                <strong class="text-primary">{{ 
                                    sortBy === 'subject' ? 'üìö Subject' : 
                                    sortBy === 'location' ? 'üìç Location' : 
                                    sortBy === 'price' ? 'üí∞ Price' : 
                                    sortBy === 'availability' ? 'üë• Available Spaces' : sortBy 
                                }}</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lessons Grid using v-for -->
                <div class="row">
                    <div class="col-md-4 mb-3" v-for="lesson in filteredAndSortedLessons" :key="lesson._id">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <!-- Font Awesome Icon based on subject -->
                                    <i class="fas fa-2x me-3" 
                                       :class="{
                                           'fa-calculator text-primary': lesson.subject === 'Mathematics',
                                           'fa-book text-success': lesson.subject === 'English',
                                           'fa-flask text-info': lesson.subject === 'Science' || lesson.subject === 'Chemistry',
                                           'fa-landmark text-warning': lesson.subject === 'History',
                                           'fa-globe text-secondary': lesson.subject === 'Geography',
                                           'fa-palette text-danger': lesson.subject === 'Art',
                                           'fa-music text-purple': lesson.subject === 'Music',
                                           'fa-atom text-dark': lesson.subject === 'Physics',
                                           'fa-microscope text-success': lesson.subject === 'Biology'
                                       }"></i>
                                    <h5 class="card-title mb-0">{{ lesson.subject }}</h5>
                                </div>
                                <div class="card-text">
                                    <p class="mb-2">
                                        <i class="fas fa-map-marker-alt text-muted me-2"></i>
                                        <strong>Location:</strong> {{ lesson.location }}
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-pound-sign text-muted me-2"></i>
                                        <strong>Price:</strong> ¬£{{ lesson.price }}
                                    </p>
                                    <p class="mb-3">
                                        <i class="fas fa-users text-muted me-2"></i>
                                        <strong>Available Spaces:</strong> 
                                        <span :class="{ 'text-danger': lesson.availability === 0, 'text-success': lesson.availability > 0 }">
                                            {{ lesson.availability }}
                                        </span>
                                    </p>
                                </div>
                                <button 
                                    class="btn w-100" 
                                    :class="{
                                        'btn-secondary': lesson.availability === 0,
                                        'btn-success': cartItems.find(item => item._id === lesson._id),
                                        'btn-primary': lesson.availability > 0 && !cartItems.find(item => item._id === lesson._id)
                                    }"
                                    :disabled="lesson.availability === 0"
                                    @click="addToCart(lesson)"
                                    :title="lesson.availability === 0 ? 'No spaces available' : 
                                           cartItems.find(item => item._id === lesson._id) ? 'Already in cart' : 
                                           `Add ${lesson.subject} to cart`">
                                    <i class="fas me-2" :class="{
                                        'fa-times-circle': lesson.availability === 0,
                                        'fa-check-circle': cartItems.find(item => item._id === lesson._id),
                                        'fa-shopping-cart': lesson.availability > 0 && !cartItems.find(item => item._id === lesson._id)
                                    }"></i>
                                    {{ lesson.availability === 0 ? 'Sold Out' : 
                                       cartItems.find(item => item._id === lesson._id) ? 'In Cart' : 
                                       'Add to Cart' }}
                                    <span v-if="lesson.availability > 0" class="badge bg-light text-dark ms-2">
                                        {{ lesson.availability }} left
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="filteredAndSortedLessons.length === 0" class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    No lessons found matching your search criteria.
                </div>

                <!-- Sorting Information Display -->
                <div v-if="filteredAndSortedLessons.length > 0" class="alert alert-light border mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <i class="fas fa-sort me-2 text-primary"></i>
                            <strong>Sorting Results:</strong> 
                            Showing {{ filteredAndSortedLessons.length }} lessons sorted by 
                            <span class="badge bg-primary">{{ 
                                sortBy === 'subject' ? 'Subject' : 
                                sortBy === 'location' ? 'Location' : 
                                sortBy === 'price' ? 'Price' : 
                                'Available Spaces' 
                            }}</span>
                            in 
                            <span class="badge" :class="sortOrder === 'asc' ? 'bg-success' : 'bg-warning'">
                                {{ sortOrder === 'asc' ? 'Ascending' : 'Descending' }}
                            </span> 
                            order
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                Click the sort button to reverse order
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart View -->
            <div v-if="currentView === 'cart'">
                <h2><i class="fas fa-shopping-cart me-2"></i>Shopping Cart</h2>
                
                <div v-if="cartItems.length === 0" class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Your cart is empty. <a href="#" @click.prevent="currentView = 'lessons'">Browse lessons</a>
                </div>

                <div v-else>
                    <!-- Cart Items -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <div v-for="item in cartItems" :key="item._id" class="row align-items-center mb-3 pb-3 border-bottom">
                                        <div class="col-md-3">
                                            <strong>{{ item.subject }}</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <i class="fas fa-map-marker-alt text-muted me-1"></i>
                                            {{ item.location }}
                                        </div>
                                        <div class="col-md-3">
                                            <i class="fas fa-pound-sign text-muted me-1"></i>
                                            ¬£{{ item.price }}
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-danger btn-sm" @click="removeFromCart(item._id)">
                                                <i class="fas fa-trash me-1"></i>Remove
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-9">
                                            <strong>Total:</strong>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>¬£{{ cartTotal }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Checkout Form -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-credit-card me-2"></i>Checkout Information</h5>
                                </div>
                                <div class="card-body">
                                    <form @submit.prevent="checkout">
                                        <div class="mb-3">
                                            <label for="name" class="form-label">
                                                <i class="fas fa-user me-2"></i>Full Name *
                                            </label>
                                            <input 
                                                type="text" 
                                                class="form-control" 
                                                id="name"
                                                v-model="orderForm.name" 
                                                required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="phone" class="form-label">
                                                <i class="fas fa-phone me-2"></i>Phone Number *
                                            </label>
                                            <input 
                                                type="tel" 
                                                class="form-control" 
                                                id="phone"
                                                v-model="orderForm.phone" 
                                                required>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100">
                                            <i class="fas fa-check me-2"></i>
                                            Place Order (¬£{{ cartTotal }})
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders View -->
            <div v-if="currentView === 'orders'">
                <h2><i class="fas fa-receipt me-2"></i>Order History</h2>
                
                <div v-if="orders.length === 0" class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No orders found.
                </div>

                <div v-else>
                    <div v-for="order in orders" :key="order._id" class="card mb-3">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong><i class="fas fa-hashtag me-1"></i>Order #{{ order._id.slice(-8) }}</strong>
                                </div>
                                <div class="col-md-6 text-end">
                                    <i class="fas fa-calendar me-1"></i>
                                    {{ new Date(order.createdAt).toLocaleDateString() }}
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><i class="fas fa-user me-2"></i><strong>Customer:</strong> {{ order.name }}</p>
                                    <p><i class="fas fa-phone me-2"></i><strong>Phone:</strong> {{ order.phone }}</p>
                                </div>
                                <div class="col-md-6 text-end">
                                    <h5><i class="fas fa-pound-sign me-1"></i>Total: ¬£{{ order.total }}</h5>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <h6><i class="fas fa-list me-2"></i>Lessons:</h6>
                                    <ul class="list-group list-group-flush">
                                        <li v-for="lesson in order.lessons" :key="lesson._id" 
                                            class="list-group-item d-flex justify-content-between">
                                            <span><i class="fas fa-book me-2"></i>{{ lesson.subject }} - {{ lesson.location }}</span>
                                            <span>¬£{{ lesson.price }}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue.js 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Vue.js Application Code -->
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentView: 'lessons',
                    lessons: [],
                    cartItems: [],
                    orders: [],
                    searchQuery: '',
                    sortBy: 'subject',
                    sortOrder: 'asc',
                    orderForm: {
                        name: '',
                        phone: ''
                    },
                    apiBaseUrl: 'https://your-api-url.com/api' // Update this with your deployed API URL
                }
            },
            computed: {
                filteredAndSortedLessons() {
                    let filtered = this.lessons;
                    
                    // Filter by search query
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(lesson => 
                            lesson.subject.toLowerCase().includes(query) ||
                            lesson.location.toLowerCase().includes(query)
                        );
                    }
                    
                    // Sort lessons by selected attribute
                    filtered.sort((a, b) => {
                        let aValue = a[this.sortBy];
                        let bValue = b[this.sortBy];
                        
                        // Handle different data types for sorting
                        if (this.sortBy === 'price' || this.sortBy === 'availability') {
                            // Numeric sorting for price and availability
                            aValue = Number(aValue);
                            bValue = Number(bValue);
                        } else {
                            // String sorting for subject and location (case-insensitive)
                            aValue = String(aValue).toLowerCase();
                            bValue = String(bValue).toLowerCase();
                        }
                        
                        // Apply sort order (ascending or descending)
                        if (this.sortOrder === 'asc') {
                            return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
                        } else {
                            return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
                        }
                    });
                    
                    return filtered;
                },
                cartTotal() {
                    return this.cartItems.reduce((total, item) => total + item.price, 0);
                }
            },
            methods: {
                async fetchLessons() {
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/lessons`);
                        if (response.ok) {
                            this.lessons = await response.json();
                        } else {
                            console.error('Failed to fetch lessons');
                            // Fallback to mock data for development
                            this.loadMockData();
                        }
                    } catch (error) {
                        console.error('Error fetching lessons:', error);
                        // Fallback to mock data for development
                        this.loadMockData();
                    }
                },
                
                async fetchOrders() {
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/orders`);
                        if (response.ok) {
                            this.orders = await response.json();
                        }
                    } catch (error) {
                        console.error('Error fetching orders:', error);
                    }
                },
                
                addToCart(lesson) {
                    if (lesson.availability > 0) {
                        // Check if lesson is already in cart
                        const existingItem = this.cartItems.find(item => item._id === lesson._id);
                        if (!existingItem) {
                            this.cartItems.push({ ...lesson });
                            // Decrease availability in the lessons array
                            const lessonIndex = this.lessons.findIndex(l => l._id === lesson._id);
                            if (lessonIndex !== -1) {
                                this.lessons[lessonIndex].availability--;
                            }
                        }
                    }
                },
                
                removeFromCart(lessonId) {
                    const itemIndex = this.cartItems.findIndex(item => item._id === lessonId);
                    if (itemIndex !== -1) {
                        // Increase availability back in lessons array
                        const lessonIndex = this.lessons.findIndex(l => l._id === lessonId);
                        if (lessonIndex !== -1) {
                            this.lessons[lessonIndex].availability++;
                        }
                        this.cartItems.splice(itemIndex, 1);
                    }
                },
                
                async checkout() {
                    if (this.cartItems.length === 0) return;
                    
                    const orderData = {
                        name: this.orderForm.name,
                        phone: this.orderForm.phone,
                        lessons: this.cartItems.map(item => ({
                            _id: item._id,
                            subject: item.subject,
                            location: item.location,
                            price: item.price
                        })),
                        total: this.cartTotal
                    };
                    
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/orders`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(orderData)
                        });
                        
                        if (response.ok) {
                            const newOrder = await response.json();
                            this.orders.unshift(newOrder);
                            
                            // Update lesson availability on server
                            for (const item of this.cartItems) {
                                await this.updateLessonAvailability(item._id, -1);
                            }
                            
                            // Clear cart and form
                            this.cartItems = [];
                            this.orderForm.name = '';
                            this.orderForm.phone = '';
                            
                            alert('Order placed successfully!');
                            this.currentView = 'orders';
                        } else {
                            alert('Failed to place order. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error placing order:', error);
                        alert('Error placing order. Please try again.');
                    }
                },
                
                async updateLessonAvailability(lessonId, change) {
                    try {
                        await fetch(`${this.apiBaseUrl}/lessons/${lessonId}/availability`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ change })
                        });
                    } catch (error) {
                        console.error('Error updating lesson availability:', error);
                    }
                },
                
                loadMockData() {
                    // Mock data for development/testing - 10 lessons with at least 5 spaces each
                    this.lessons = [
                        {
                            _id: '1',
                            subject: 'Mathematics',
                            location: 'London',
                            price: 25,
                            availability: 5
                        },
                        {
                            _id: '2',
                            subject: 'English',
                            location: 'Manchester',
                            price: 20,
                            availability: 5
                        },
                        {
                            _id: '3',
                            subject: 'Science',
                            location: 'Birmingham',
                            price: 30,
                            availability: 8
                        },
                        {
                            _id: '4',
                            subject: 'History',
                            location: 'Liverpool',
                            price: 22,
                            availability: 5
                        },
                        {
                            _id: '5',
                            subject: 'Geography',
                            location: 'Leeds',
                            price: 18,
                            availability: 6
                        },
                        {
                            _id: '6',
                            subject: 'Art',
                            location: 'Bristol',
                            price: 28,
                            availability: 5
                        },
                        {
                            _id: '7',
                            subject: 'Music',
                            location: 'Edinburgh',
                            price: 35,
                            availability: 5
                        },
                        {
                            _id: '8',
                            subject: 'Physics',
                            location: 'Glasgow',
                            price: 32,
                            availability: 7
                        },
                        {
                            _id: '9',
                            subject: 'Chemistry',
                            location: 'Cardiff',
                            price: 29,
                            availability: 5
                        },
                        {
                            _id: '10',
                            subject: 'Biology',
                            location: 'Belfast',
                            price: 27,
                            availability: 5
                        }
                    ];
                }
            },
            
            mounted() {
                this.fetchLessons();
                this.fetchOrders();
            }
        }).mount('#app');
    </script>
</body>
</html>